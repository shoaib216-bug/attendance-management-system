{% extends "base.html" %}

{% block title %}Mark Attendance{% endblock %}

{% block content %}
<h2>Mark Attendance for {{ subject }} (Period {{ period }}) on {{ date }}</h2>

<form id="attendance-form" action="{{ url_for('staff.submit_attendance') }}" method="POST">
    <input type="hidden" name="period" value="{{ period }}">
    <input type="hidden" name="subject" value="{{ subject }}">

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Roll No</th>
                    <th>Name</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                <tr>
                    <td>{{ student.roll_no }}</td>
                    <td>{{ student.name }}</td>
                    <td>
                        <input type="hidden" name="student_id" value="{{ student.student_id }}">
                        <label style="margin-right: 1rem;"><input type="radio" name="status_{{ student.student_id }}"
                                value="Present" checked> Present</label>
                        <label><input type="radio" name="status_{{ student.student_id }}" value="Absent"> Absent</label>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <button type="submit" class="btn" style="margin-top: 20px;">Submit Attendance</button>
</form>

<!-- ========================================================================= -->
<!-- === THE FINAL, ROBUST GEOLOCATION SCRIPT === -->
<!-- ========================================================================= -->
<!-- At the bottom of mark_attendance.html -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('attendance-form');
        if (form) {
            const submitButton = form.querySelector('button[type="submit"]');

            form.addEventListener('submit', function(event) {
                event.preventDefault();
                submitButton.disabled = true;
                submitButton.textContent = 'Getting Your Location...';
                submitButton.style.backgroundColor = '#6c757d';

                function success(position) {
                    const latInput = document.createElement('input'); latInput.type = 'hidden'; latInput.name = 'latitude';
                    latInput.value = position.coords.latitude; form.appendChild(latInput);
                    const lonInput = document.createElement('input'); lonInput.type = 'hidden'; lonInput.name = 'longitude';
                    lonInput.value = position.coords.longitude; form.appendChild(lonInput);
                    form.submit();
                }

                function error(err) {
                    let errorMessage = 'Could not get your location. Please check your network and try again.';
                    if (err.code === 1) { errorMessage = 'Location access was denied. You must re-enable it in your browser\'s site settings.'; }
                    else if (err.code === 3) { errorMessage = 'The request for location timed out. Please ensure you have a stable network connection and try again.'; }
                    alert(errorMessage);
                    resetButton();
                }

                function resetButton() {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Submit Attendance';
                    submitButton.style.backgroundColor = '';
                }

                navigator.geolocation.getCurrentPosition(success, error, { enableHighAccuracy: true, timeout: 7000, maximumAge: 0 });
            });
        }
    });
</script>
{% endblock %}